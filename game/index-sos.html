<!DOCTYPE html>
<html>
<script>
console.warn = console.error
</script>
<!-- include three.js stuff -->
<script src='../../../vendor/three.js/build/three.min.js'></script>
<script src='../../../vendor/three.js/examples/js/modifiers/SubdivisionModifier.js'></script>
<script src='../../../vendor/three.js/examples/js/ImprovedNoise.js'></script>

<script src="vendor/virtualjoystick.js"></script>
<!-- include stats.js stuff -->
<script src="bower_components/stats.js/build/Stats.js"></script>
<!-- include threex.rendererstats.js stuff -->
<script src="bower_components/threex.rendererstats/threex.rendererstats.js"></script>
<!-- include require.js stuff -->
<script src="../../../vendor/require.js/require.js"></script>
<!-- include threex.cannonjs -->
<script src='../../threex.cannonjs/vendor/cannon.js/build/cannon.min.js'></script>
<script src='../../threex.cannonjs/threex.cannonworld.js'></script>
<script src='../../threex.cannonjs/threex.cannonbody.js'></script>
<!-- include threex.keyboardstate -->
<script src="../../threex.keyboardstate/threex.keyboardstate.js"></script>
<!-- include threex.windowresize -->
<script src="../../threex.windowresize/threex.windowresize.js"></script>
<!-- include for threex.glowdatgui -->
<script src='../../../vendor/three.js/examples/js/libs/dat.gui.min.js'></script>
<script src="../../threex.glow/threex.glowdatgui.js"></script>
<!-- include for threex.mirrorball -->
<script src='../../threex.mirrorball/threex.mirrorball.js'></script>

<!-- include for threex.poolball -->
<script src='../../threex.poolball/threex.poolball.js'></script>


<script src='vendor/microcache.js'></script>
<script src='vendor/microevent.js'></script>
<script src='vendor/gowiththeflow.js'></script>

<script src="vendor/Tween.js"></script>
<!-- include for threex.mirrorball -->
<script src='vendor/webaudiox/build/webaudiox-bundle.js'></script>
<!-- include the .js files for jsfx.js -->
<script src="vendor/webaudiox/examples/vendor/jsfx/audio.js"></script>
<script src="vendor/webaudiox/examples/vendor/jsfx/jsfx.js"></script>
<script src="vendor/webaudiox/examples/vendor/jsfx/jsfxlib.js"></script>

<script src='js/initlighting.js'></script>
<script src='js/gametimer.js'></script>
<script src='js/gamescore.js'></script>
<script src='js/emitterbluetrail.js'></script>
<script src='js/emitterimpactball.js'></script>
<script src='js/emitterspeedtrail.js'></script>
<script src='js/emitterscore.js'></script>
<script src='js/juiceintensityball.js'></script>
<script src='js/soundsbank.js'></script>
<script src='js/player.js'></script>
<script src='js/botenemy.js'></script>
<script src='js/botball.js'></script>
<script src='js/botbouncer.js'></script>
<script src='js/botgoal.js'></script>
<script src='js/playercontrols.js'></script>
<script src='js/maptable.js'></script>
<script src='js/map01.js'></script>
<script src='js/map02.js'></script>
<script src='js/map03.js'></script>
<script src='js/map04.js'></script>
<script src='js/renderingprofile.js'></script>
<script src='js/threex.smoothholdercontrols.js'></script>
<script src='js/threex.lingeringcontrols.js'></script>

<body style='margin: 0px; background-color: #000000; overflow: hidden;'>

<style>
@font-face {	/* for mute button which is part of awesome font */
	font-family: 'FontAwesome';
	src: url('vendor/Font-Awesome/font/fontawesome-webfont.eot?v=3.2.1');
	src: url('vendor/Font-Awesome/font/fontawesome-webfont.eot?#iefix&v=3.2.1') format('embedded-opentype'), url('vendor/Font-Awesome/font/fontawesome-webfont.woff?v=3.2.1') format('woff'), url('vendor/Font-Awesome/font/fontawesome-webfont.ttf?v=3.2.1') format('truetype'), url('vendor/Font-Awesome/font/fontawesome-webfont.svg#fontawesomeregular?v=3.2.1') format('svg');
	font-weight: normal;
	font-style: normal;
}
</style>
<!-- include Score html -->	
<style>
.osdFont {
	font-family	: arial, verdana, sans-serif;
	font-size	: 500%;
	font-weight	: bolder;

	color		: #000;
	text-shadow	: 0 0 0.2em #fbc, 0 0 0.2em #fbc, 0 0 0.2em #fbc;
}
</style>

<style>
#osdLeftColumn {
	position	: absolute;
	text-align	: left;

	top		: 0;
	left		: 0;
	padding-left	: 10px;
}
#muteOsd {
	font-family: FontAwesome;
}
#muteOsd:before {
	content: "\f028";	/* icon for non mute */
}
#muteOsd.muted:before {
	content: "\f026";	/* icon for muted */
}
</style>
<div id='osdLeftColumn'>
	<div id="score" class='osdFont'></div>
	<div id="muteOsd" class='osdFont'></div>
</div>
<!-- include live html -->	
<style>
#osdRightColumn {
	position	: absolute;
	text-align	: right;

	top		: 0;
	right		: 0;
	padding-right	: 10px;
}
</style>
<div id='osdRightColumn'>
	<div id="livesCounter" class='osdFont'>3</div>
</div>
<style>
#osdCenterColumn {
	position	: absolute;
	top		: 30%; 

	text-align	: center;
	width		: 100%;
}
</style>
<div id='osdCenterColumn'>
	<div id="gameStartOsd" class='osdFont' style='display:none'>Ready ?</div>
	<div id="gameLostOsd" class='osdFont' style='display:none'>Game Over</div>
	<div id="gameWonOsd" class='osdFont' style='display:none'>Game Won</div>
	<div id="gameCompletedOsd" class='osdFont' style='display:none'>Game Completed</div>
	<div id="killPlayerOsd" class='osdFont' style='display:none'>You die!</div>
</div>
<script>
require([ '../../threex.glow/package.require.js'
	, '../../threex.skymap/package.require.js'
], function(){
	window.cache	= new Microcache()
	window.yeller	= MicroeventMixin({});
	window.GAME	= {}

	GAME.tileW	= 0.2
	GAME.nLives	= 3;
	document.querySelector('#livesCounter').innerHTML	= GAME.nLives
	GAME.mapId	= location.hash ? location.hash.substr(1) : '01'

	var onMobile	= 'ontouchstart' in window ? true : false
	GAME.profile	= new RenderingProfile(onMobile ? 'mobile' : 'normal')


	//////////////////////////////////////////////////////////////////////////////////
	//		comment								//
	//////////////////////////////////////////////////////////////////////////////////
	
	var renderer	= new THREE.WebGLRenderer({
		antialias	: GAME.profile.rendererAntialias
	})
	renderer.setSize( window.innerWidth, window.innerHeight )
	document.body.appendChild( renderer.domElement )

	var updateFcts	= []
	var scene	= new THREE.Scene()
	var camera	= new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.01, 100)
	camera.position.x	= 0
	camera.position.y	= 5
	camera.position.z	= 6
	camera.lookAt( scene.position )

	// setup winResize
	var windowResize	= new THREEx.WindowResize(renderer, camera)
	// set deviceProfileRatio
	renderer.devicePixelRatio	= GAME.profile.devicePixelRatio
	windowResize.trigger();

	;(function(){
		var stats	=  new Stats();
		// Align top-left
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.left	= '0px';
		stats.domElement.style.bottom	= '0px';
		document.body.appendChild( stats.domElement );
		updateFcts.push(function(delta, now){
			stats.update();		
		})
	})()

	;(function(){
		var rendererStats	= new THREEx.RendererStats()
		rendererStats.domElement.style.position	= 'absolute'
		rendererStats.domElement.style.right	= '0px'
		rendererStats.domElement.style.bottom	= '0px'
		document.body.appendChild( rendererStats.domElement )
		updateFcts.push(function(delta, now){
			rendererStats.update(renderer);
		})
	})()

	renderer.shadowMapEnabled	= GAME.profile.shadowMapEnabled ? true : false

	// init keyboard		
	var keyboard	= new THREEx.KeyboardState(document.body);
	window.keyboard	= keyboard
	keyboard.domElement.setAttribute("tabIndex", "0");
	keyboard.domElement.focus();

	var joystick	= new VirtualJoystick({
		container	: renderer.domElement.parent,
		mouseSupport	: false
	})
	GAME.joystick	= joystick


	window.scene	= scene
	window.renderer	= renderer
	window.camera	= camera

	//////////////////////////////////////////////////////////////////////////////////
	//		comment								//
	//////////////////////////////////////////////////////////////////////////////////
	

	var physicsWorld= new THREEx.CannonWorld()
	physicsWorld.start()

	window.physicsWorld	= physicsWorld


	// Create a slippery material (friction coefficient = 0.0)
	var pMaterialEnemy	= new CANNON.Material('pMaterialEnemy')
	var pMaterialPlayer	= new CANNON.Material('pMaterialPlayer')
	var pMaterialGround	= new CANNON.Material('pMaterialGround')
	var pMaterialWall	= new CANNON.Material('pMaterialWall')

	window.pMaterialEnemy	= pMaterialEnemy
	window.pMaterialPlayer	= pMaterialPlayer
	window.pMaterialGround	= pMaterialGround
	window.pMaterialWall	= pMaterialWall
	
	// We must add the contact materials to the world
	physicsWorld.world.addContactMaterial(new CANNON.ContactMaterial(
		pMaterialPlayer,
		pMaterialEnemy,
		0.01,	// friction coefficient
		1	// restitution
	));
	physicsWorld.world.addContactMaterial(new CANNON.ContactMaterial(
		pMaterialPlayer,
		pMaterialWall,
		0.00,	// friction coefficient
		1.2	// restitution
	));
	// We must add the contact materials to the world
	physicsWorld.world.addContactMaterial(new CANNON.ContactMaterial(
		pMaterialPlayer,
		pMaterialGround,
		0.01,		// friction coefficient
		0.6		// restitution
	));

	
	updateFcts.push(function(delta, now){
	        var up		= camera.up.clone().setLength(9.81)
	        var gravity	= physicsWorld.world.gravity
	        gravity.x	= -up.x
	        gravity.y	= -up.y
	        gravity.z	= -up.z
	})
	
	;(function(){
		var euler	= new THREE.Euler
		var matrix	= new THREE.Matrix4
		updateFcts.push(function(delta, now){
			if( keyboard.pressed('j') )	euler.z	-= 0.3*delta*Math.PI*2
			if( keyboard.pressed('l') )	euler.z	+= 0.3*delta*Math.PI*2
			if( keyboard.pressed('i') )	euler.x	-= 0.3*delta*Math.PI*2
			if( keyboard.pressed('k') )	euler.x	+= 0.3*delta*Math.PI*2

			euler.x	*= 0.95;
			euler.z	*= 0.95;

			matrix.makeRotationFromEuler(euler)
			camera.up.set(0,1,0).applyMatrix4(matrix)
		})
	})()


	//////////////////////////////////////////////////////////////////////////////////
	//		comment								//
	//////////////////////////////////////////////////////////////////////////////////
	
	GAME.emitterImpactBall	= new EmitterImpactBall(scene)
	updateFcts.push(function(delta, now){
		GAME.emitterImpactBall.update(delta, now)
	})
	GAME.emitterSpeedTrail	= new EmitterSpeedTrail(scene)
	updateFcts.push(function(delta, now){
		GAME.emitterSpeedTrail.update(delta, now)
	})
	GAME.emitterBlueTrail	= new EmitterBlueTrail(scene)
	updateFcts.push(function(delta, now){
		GAME.emitterBlueTrail.update(delta, now)
	})
	GAME.emitterScore	= new EmitterScore(scene)
	updateFcts.push(function(delta, now){
		GAME.emitterScore.update(delta, now)
	})
	
	
	//////////////////////////////////////////////////////////////////////////////////
	//		comment								//
	//////////////////////////////////////////////////////////////////////////////////
	
	
	// create soundsBank
	window.sounds	= new SoundsBank(GAME.profile.soundEnabled);
	window.soundsBank	= sounds
	// update soundsBank - usefull for sound localisation
	sounds.soundEnabled && updateFcts.push(function(delta, now){
		sounds.update(delta, now)
	})
	// handle mute UI
	document.querySelector('#muteOsd').addEventListener('click', function(event){
		if( sounds.soundEnabled === false )	return
		// change sounds
		sounds.lineOut.toggeMute()
		// change display
		var element	= event.target
		element.classList.toggle("muted");
		// save 
		localStorage.setItem('isMuted', sounds.lineOut.isMuted ? 'muted' : 'no' )
	})
	if( localStorage.getItem('isMuted') === 'muted' || sounds.soundEnabled === false ){
		var element	= document.querySelector('#muteOsd')
		element.classList.toggle("muted");
		sounds.soundEnabled && sounds.lineOut.toggeMute()
	}
	
	//////////////////////////////////////////////////////////////////////////////////
	//		comment								//
	//////////////////////////////////////////////////////////////////////////////////
	
	// init lighting
	initLighting(renderer, scene)

	// keep updating tween.js
	updateFcts.push(function(delta, now){
		TWEEN.update()	
	})	

	// add a skymap	
	if( GAME.profile.skymapEnabled ){
		var mesh	= THREEx.createSkymap('skybox')
		scene.add( mesh )		
	}

	// // add gameTimer
	// var gameTimer	= new GameTimer()
	// updateFcts.push(function(delta, now){
	// 	gameTimer.update(delta, now)
	// })


	//////////////////////////////////////////////////////////////////////////////////
	//		comment								//
	//////////////////////////////////////////////////////////////////////////////////
	
	var gameScore	= new GameScore()
	// to init score display at 0
	yeller.dispatchEvent('increaseScore', 0)

	//////////////////////////////////////////////////////////////////////////////////
	//		ball								//
	//////////////////////////////////////////////////////////////////////////////////
	var player	= new Player({
		liveMirror	: GAME.profile.playerLiveMirror
	})
	GAME.ball	= player.mesh
	updateFcts.push(function(delta, now){
		player.update(delta, now)
	})
	var body	= GAME.ball.userData.cannonBody.body
	body.position.set(-15*GAME.tileW, 20*GAME.tileW, 0*GAME.tileW)

	//////////////////////////////////////////////////////////////////////////
	//		User Controls						//
	//////////////////////////////////////////////////////////////////////////

	var playerControls	= new PlayerControls(GAME.ball)
	updateFcts.push(function(delta, now){
		playerControls.update(delta, now)
	})

	// if the ball is below the table, kill it
	updateFcts.push(function(delta, now){
		var body	= GAME.ball.userData.cannonBody.body
		var position	= body.position
		if( position.y < -2 )	yeller.dispatchEvent('killPlayer')
	})

	yeller.addEventListener('gameStart', function(){
		Flow().seq(function(next){
			document.querySelector('#gameStartOsd').style.display	= 'block'
			playerControls.disable	= true
			physicsWorld.stop()

			setTimeout(function(){
				next()
			}, 1000)		
		}).seq(function(next){
			document.querySelector('#gameStartOsd').style.display	= 'none'
			yeller.dispatchEvent('spawnPlayer')
		})
	})

	yeller.addEventListener('spawnPlayer', function(){

		playerControls.disable	= false
		if( physicsWorld.isRunning() === false )	physicsWorld.start()

		//sounds.playSpawn()

		var body	= GAME.ball.userData.cannonBody.body
		body.position.set(-15*GAME.tileW, 20*GAME.tileW, 0*GAME.tileW)
		
		body.velocity.set(0,0,0)
		body.angularVelocity.set(0,0,0)
	})

	yeller.addEventListener('killPlayer', function(){
		console.log('killPlayer')

		Flow().seq(function(next){
			playerControls.disable	= true

			sounds.playDie()
			
			var body	= GAME.ball.userData.cannonBody.body
			body.velocity.set(0,0,0)
			body.angularVelocity.set(0,0,0)

			var worldPoint	= new CANNON.Vec3(GAME.ball.position.x, GAME.ball.position.y, GAME.ball.position.z)
			var impulse	= new CANNON.Vec3( 0, 1.1, 0)
			body.applyImpulse(impulse, worldPoint)
			next()
		}).seq(function(next){
			if( GAME.nLives === 0 ){
				yeller.dispatchEvent('gameLost')
				return;
			}
			document.querySelector('#killPlayerOsd').style.display	= 'block'
			setTimeout(function(){
				next()
			}, 1000*0.8)
		}).seq(function(next){
			physicsWorld.stop()
			setTimeout(function(){
				next()
			}, 1000*0.6)
		}).seq(function(next){
			document.querySelector('#killPlayerOsd').style.display	= 'none';

			// number of lives
	 		GAME.nLives--;
	 		var domElement	= document.querySelector('#livesCounter')
	 		domElement.innerHTML	= GAME.nLives

	 		// spawn new player
			yeller.dispatchEvent('spawnPlayer')
		})
	})

	yeller.addEventListener('gameLost', function(){
		Flow().seq(function(next){
			document.querySelector('#gameLostOsd').style.display	= 'block'
			next()
		}).seq(function(next){
			setTimeout(function(){
				next()
			}, 1000*0.8)
		}).seq(function(next){
			physicsWorld.stop()
			setTimeout(function(){
				next()
			}, 1000*2)
		}).seq(function(next){
			document.querySelector('#gameLostOsd').style.display	= 'none';
			location.href	= '..'
		})
	})

	yeller.addEventListener('gameWon', function(){
		playerControls.disable	= true

		// find out nextMapId
		var mapIds	= ['01', '02', '03', '04']
		var index	= mapIds.indexOf(GAME.mapId)
		var nextMapId	= mapIds[index+1]
		console.assert( index !== -1 )
		// if there is no more level, 
		if( nextMapId === undefined ){
			yeller.dispatchEvent('gameCompleted')
			return;
		}

		Flow().seq(function(next){
			document.querySelector('#gameWonOsd').style.display	= 'block'
			next()
		}).seq(function(next){
			physicsWorld.stop()
			setTimeout(function(){
				next()
			}, 1000*2)
		}).seq(function(next){
			document.querySelector('#gameWonOsd').style.display	= 'none';
			// put nextMapId in location
			location.href	= './#'+nextMapId
			// reload the page				
			location.reload()			
		})
	})

	// 
	yeller.addEventListener('gameCompleted', function(){
		playerControls.disable	= true
		Flow().seq(function(next){
			document.querySelector('#gameCompletedOsd').style.display	= 'block'
			next()
		}).seq(function(next){
			physicsWorld.stop()
			setTimeout(function(){
				next()
			}, 1000*2)
		}).seq(function(next){
			document.querySelector('#gameCompletedOsd').style.display	= 'none';
			location.href	= '..';
		})
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		camera controls							//
	//////////////////////////////////////////////////////////////////////////////////

	// ;(function(){
	// 	var controls	= new THREEx.LingeringControls(camera, GAME.ball, 1.5)
	// 	camera.position.y = 1;
	// 	updateFcts.push(function(delta, now){
	// 		controls.update(delta, now)
	// 	})
	// })()


	var cameraHolder	= new THREE.Object3D
	scene.add(cameraHolder)

	var deltaCamera		= new THREE.Vector3(5,3,0)
	updateFcts.push(function(delta, now){
		cameraHolder.position.copy(GAME.ball.position)
		cameraHolder.position.add(deltaCamera)
	})

	;(function(){
		var controls	= new THREEx.SmoothHolderControls(camera, cameraHolder, GAME.ball)
		updateFcts.push(function(delta, now){
			controls.update(delta, now)
		})
	})()

	var deltaCameras	= [
		new THREE.Vector3( 0, 3, 5),
		new THREE.Vector3( 0, 1, 1),
		new THREE.Vector3( 1, 1, 1),
		new THREE.Vector3( 1, 1,-1),
		new THREE.Vector3(-1, 1,-1),
		new THREE.Vector3(-1, 1, 1),
		new THREE.Vector3( 0, 1, 1),
	];
	deltaCamera	= deltaCameras[0]
	// jump on space
	keyboard.domElement.addEventListener('keydown', function(event){
		var cameraIdx	= deltaCameras.indexOf(deltaCamera)
		if( cameraIdx === -1 ){
			cameraIdx	= 0
		}else if( keyboard.eventMatches(event, '2') ){
			cameraIdx++
		}else if( keyboard.eventMatches(event, '1') ){
			cameraIdx--
		}
		cameraIdx	= (cameraIdx+deltaCameras.length)%deltaCameras.length
		deltaCamera	= deltaCameras[cameraIdx]
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		comment								//
	//////////////////////////////////////////////////////////////////////////////////

	if( GAME.mapId === '01' ){
		var map		= new Map01()
	}else if( GAME.mapId === '02' ){
		var map		= new Map02()
	}else if( GAME.mapId === '03' ){
		var map		= new Map03()
	}else if( GAME.mapId === '04' ){
		var map		= new Map04()
	}else	console.assert(false)
	scene.add(map.object3d)
	updateFcts.push(function(delta, now){
		map.update(delta, now);		
	})
	
	// spawn new player
	yeller.dispatchEvent('gameStart')

	//////////////////////////////////////////////////////////////////////////////////
	//		render the scene						//
	//////////////////////////////////////////////////////////////////////////////////
	updateFcts.push(function(){
		renderer.render( scene, camera );		
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		loop runner							//
	//////////////////////////////////////////////////////////////////////////////////
	var lastTimeMsec= null
	requestAnimationFrame(function animate(nowMsec){
		// keep looping
		requestAnimationFrame( animate );
		// measure time
		lastTimeMsec	= lastTimeMsec || (nowMsec-1000/60)
		var deltaMsec	= Math.min(200, nowMsec - lastTimeMsec)
		lastTimeMsec	= nowMsec
		// call each update function
		updateFcts.forEach(function(updateFn){
			updateFn(deltaMsec/1000, nowMsec/1000)
		})
	})
})
</script></body>
</html>
